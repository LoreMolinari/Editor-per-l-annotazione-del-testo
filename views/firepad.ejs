<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firepad</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/5.5.4/firebase.js"></script>

    <!-- CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/codemirror.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/codemirror.css"
    />

    <!-- Firepad -->
    <link
      rel="stylesheet"
      href="https://firepad.io/releases/v1.5.9/firepad.css"
    />
    <script src="https://firepad.io/releases/v1.5.9/firepad.min.js"></script>

    <!-- Include example userlist script / CSS.
            Can be downloaded from: https://github.com/firebase/firepad/tree/master/examples/ -->
    <script src="./js/firepad-userlist.js"></script>
    <link rel="stylesheet" href="./css/firepad-userlist.css" />

    <!--Diff-->
    <script
      type="text/javascript"
      src="/js/diff_match_patch_uncompressed.js"
    ></script>

    <style>
      html {
        height: 100%;
      }
      body {
        margin: 0;
        height: 100%;
      }
      /* Height / width / positioning can be customized for your use case.
               For demo purposes, we make the user list 175px and firepad fill the rest of the page. */
      #container {
        display: flex;
        flex-direction: row;
      }
      #userlist {
        position: relative;
        left: 0;
        top: 0;
        bottom: 0;
        height: auto;
        width: 175px;
      }
      #firepad {
        position: relative;
        left: 5%;
        top: 0;
        bottom: 0;
        right: 0;
        height: auto;
      }
    </style>
  </head>
  <body onload="init()">
    <div id="container">
      <div id="userlist"></div>
      <div id="firepad"></div>
    </div>
    <div>
      <button onclick="goToRecogito()">Ritorna all'editor annotativo</button>
    </div>

    <script>
      var firepadRef;
      var codeMirror;
      var firepad;
      var dataRecogito;

      function init() {
        //// Initialize Firebase.
        //// TODO: replace with your Firebase project configuration.
        var config = {
          apiKey: "<API_KEY>",
          authDomain: "firepad-gh-tests.firebaseapp.com",
          databaseURL: "https://firepad-gh-tests.firebaseio.com",
        };
        firebase.initializeApp(config);

        //// Get Firebase Database reference.
        firepadRef = getExampleRef();

        //// Create CodeMirror (with lineWrapping on).
        codeMirror = CodeMirror(document.getElementById("firepad"), {
          lineWrapping: true,
        });

        // Create a random ID to use as our user ID (we must give this to firepad and FirepadUserList).
        userId = Math.floor(Math.random() * 9999999999).toString();

        //// Create Firepad (with rich text features and our desired userId).
        firepad = Firepad.fromCodeMirror(firepadRef, codeMirror, {
          richTextToolbar: true,
          richTextShortcuts: true,
          userId: userId,
        });

        //// Create FirepadUserList (with our desired userId).
        var firepadUserList = FirepadUserList.fromDiv(
          firepadRef.child("users"),
          document.getElementById("userlist"),
          userId
        );

        //// Initialize contents.
        firepad.on("ready", function () {
          if (firepad.isHistoryEmpty()) {
            fetch("/text")
              .then((res) => res.text())
              .then((data) => {
                dataRecogito = data;
                firepad.setHtml(data);
                localStorage.setItem("prevtext", data);
              });
          }
        });
      }

      function getExampleRef() {
        var ref = firebase.database().ref();
        var hash = window.location.hash.replace(/#/g, "");
        if (hash) {
          ref = ref.child(hash);
        } else {
          ref = ref.push();
          window.location = window.location + "#" + ref.key;
        }
        if (typeof console !== "undefined") {
          console.log("Firebase data: ", ref.toString());
        }
        return ref;
      }

      function goToRecogito() {
        str = diffBasic(dataRecogito, firepad);

        fetch("/text", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            text: firepad
              .getHtml()
              .replaceAll("<div>", "<p>")
              .replaceAll("</div>", "</p>")
              .replaceAll("&#39;", "'"),
            version: window.location.hash.replace(/#/g, ""),
          }),
        }).then(
            fetch("/diff", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                prevtext: localStorage.getItem("prevtext"),
                diff: str,
              }),
            }),
            localStorage.removeItem("prevtext")
          ).then(() => (location.href = "/exit/firepad"));

        function diffBasic(dataRecogito, firepad) {
          var dmp = new diff_match_patch();

          var diff = dmp.diff_main(
            dataRecogito,
            firepad
              .getHtml()
              .replaceAll("<div>", "<p>")
              .replaceAll("</div>", "</p>")
              .replaceAll("&#39;", "'")
          );

          return diff;
        }
      }
    </script>
  </body>
</html>
